---
title: "TBD"
subtitle: "TBD"
author: "TBD"
thanks: "Code and data are available at: LINK."
date: "`r format(Sys.time(), '%d %B %Y')`"
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
output:
  bookdown::pdf_document2:
toc: FALSE
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(janitor)
library(dplyr)
library(palettetown)
library(RColorBrewer)
library(ggthemes)
library(scales)
library(broom)
library(purrr)
#devtools::install_github("johannesbjork/LaCroixColoR")
library(LaCroixColoR)

all_simulated_dataset <- 
  readr::read_csv("../../inputs/data/simulated_data.csv")
```

```{r, echo = FALSE, include=FALSE, message = FALSE}
#### Global Functions ####

### Format percent
percent <- function(x, decimal = 2, format = "f") {   
  paste0(formatC(x, format = format, digits = decimal), "%")
}

### Format table for Chi-squared test
tableChisq <- function(capt, stat, df, p) {   
  chi_stat <- c(stat)
  chi_param <- c(df)
  chi_p <- c(p)
  chi_df <- data.frame(chi_stat, chi_param, chi_p)
  
  kable(chi_df,
        digits = 2,
        caption = capt,
        col.names = c("X-squared",
                      "df",
                      "p-value")) %>%
    kable_paper(c("striped", "hover"))
}

```

# Data

## Results

Questions pertaining to the characteristics of the restaurants, such as location, size, type, and age of restaurants (Figures 1-5) show us that:

* the largest concentration (nearly 60%) of restaurants in the Greater Toronto Area are centralized in downtown Toronto (28.26%), North York (15.78%), and Scarborough (13.74%);
* most restaurants are of medium or larger scale, with seating areas of at least 30; 
* a majority of the restaurants are relatively new (1-4 years old); 
* fast-food/quick service restaurants are most common, followed by casual dining, and then fine dining;
* and UberEats is the most popular food courier service in the city.

Tables 1 and 2 speak to changes in numbers of employees for restaurants prior to the intervention period (Oct 1) and following the intervention period (Dec 31). This shows us that initially, both the control and treatment group had a very similar number of employees on average. Following the intervention period, however, the treatment group appears to have 10.26 fewer employees on average. Two-tailed Welch's t-tests comparing the two groups' mean employees shows that the difference prior to the intervention period is not a significant finding ( *t*(330) = -8.56, *p* > .05)., but the difference in employee numbers between the two groups post-intervention is significant( *t*(330) = 19.46, *p* < .05).

In terms of effects on revenue and/or overall sales for restaurants during the intervention period, Figure 5 shows us that more restaurants within the treatment group saw decreases in revenue compared to the prior quarter (July 1 - Sep 30), while the control group's revenue largely remained the same. In addition to this, Figure 6 shows that of those restaurants that saw a decrease in revenue, the treatment group saw the harshest declines in revenue during the intervention period. A Chi-Square test for whether the restaurant saw a decrease in revenue showed that restaurants in the treatment group were more likely to report a decrease in revenue *X*^2 (2, *N* = 330) = 220.73, *p* < 2.2e-16. The percentage decrease in revenues also showed a significant relationship, where restaurants in the treatment group are most likely to report higher loss of revenue during the intervention period *X*^2 (3, *N* = 330) = 178.33, *p* < 2.2e-16. Prior to the intervention period, it appears as though both groups had similar breakdowns of revenue coming from take-out and/or delivery (Figure 7).

Questions related to the adjustments of the restaurants during the intervention, such as a menu price, and hours and days of operation (Figures 8-12) show us that:

* most of the restaurants in the control group did not change the menu price, while most of the ones in the treatment group either lowered or raised the menu price;
* and most of the restaurants in the control group did not adjust their hours and days of operation, while most of the ones in the intervention group reduced their operating schedule.

Pearsonâ€™s Chi-squared test is used to see if there is a statistically significant difference between the intervention and the adjustments of the restaurants. The test results show that the p-value of each of those adjustments is close to 0 (*p* < 2.2e-16), meaning that there is a high correlation between those two variables. Consequently, it is expected that restaurants will adjust the menu price and reduce their operating schedule if they operate on a delivery and take-out only basis.


## Figures

### Sample Characteristics

```{r regions, echo = FALSE, message = FALSE}
#### Pie Chart ####
### Import cleaned business licences dataset
dfCleanBiz <- readr::read_csv("../../inputs/data/clean_business_licences.csv")
### Create data frame
dfBoroughs <- data.frame(
  group = dfCleanBiz$fsa,
  value = dfCleanBiz$n
)
### Calculate percentages
dfBoroughs <- dfBoroughs %>% 
  arrange(desc(group)) %>%
  mutate(prop = value / sum(dfBoroughs$value) *100) %>%
  mutate(ypos = cumsum(prop)- 0.5*prop ) %>%
  arrange(desc(prop))
dfBoroughs <- dfBoroughs[-c(10),]
# print(dfBoroughs)

### Create pie chart
ggplot(dfBoroughs, aes(x="", y = prop, fill = group)) +
  geom_bar(stat = "identity", width = 1, color = "black") +
  coord_polar("y", start = 0) +
  geom_text(aes(x=1.65, y = ypos, label = percent(prop)), color = "black", size=2.8) +
  scale_fill_manual(values=lacroix_palette("PeachPear", n = 9)) + 
  labs(fill = "Region", title = "Proportion of Restaurants in Toronto by Borough") +
  theme(plot.title = element_text(face = "bold")) +
  theme_void() +
  theme(plot.title = element_text(face = "bold"))
```

```{r Q1, echo = FALSE, message=FALSE}
ggplot(data = all_simulated_dataset, mapping = aes (x = Q1, fill = type)) +
  geom_bar() + coord_flip() +
  theme_fivethirtyeight() +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE)) +
  labs(fill = "Condition", title = "Location of restaurants")
```

```{r Q2, echo = FALSE, message = FALSE}
### How would you best describe the scale of your restaurant? (in terms of space and seating capacity)
### Small (full seating capacity is under 30)
### Medium (full seating capacity between 30 and 60)
### Large (full seating capacity is 60+) "
ggplot(data = all_simulated_dataset, mapping = aes (x = Q2, fill = type)) +
    geom_bar() +
  scale_x_discrete(limit = c ("Small", "Medium", "Large")) +
  labs(x = "Seating Capacity",
       y = "# of Restaurants",
       fill = "Condition",
       title = "Scale of restaurant (space/seating capacity)") +
  theme_fivethirtyeight() +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE))
```

```{r Q3, echo = FALSE, message = FALSE}
### What best describes your restaurant segmentation?
### Fast-food/quick service
### Casual Dining
### Fine Dining
### Other
ggplot(data = all_simulated_dataset, mapping = aes (x = Q3, fill = type)) +
  geom_bar() +
  scale_x_discrete(limit = c ("Fine Dining", "Casual Dining", "Fast-food/quick service", "Other")) +
  labs(x = "Restaurant Type",
       y = "# of Restaurants",
       fill = "Condition",
       title = "Type of restaurant") +
  theme_fivethirtyeight() +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE))
```

```{r Q4, echo = FALSE, message = FALSE}
### How many years has your restaurant been in operation?
### 1-4 years
### 5-7 years
### 8-10 years
### 10 or more years
ggplot(data = all_simulated_dataset, mapping = aes (x = Q4, fill = type)) +
  geom_bar() + coord_flip() +
  scale_x_discrete(limit = c ("1-4 years", "5-7 years", "8-10 years", "10 or more years")) +
  labs(x = "Years of Operation",
       y = "# of Restaurants",
       fill = "Condition",
       title = str_wrap("Number of years restaurants have been in operation", 30)) +
  theme_fivethirtyeight() +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE))
```

```{r Q11, echo = FALSE, message = FALSE}
### Between Oct 1 and Dec 31, which food courier service did you receive the most orders from?
### UberEats
### SkiptheDishes 
### DoorDash
### Other
### In-house delivery service
### None

ggplot(data = all_simulated_dataset, mapping = aes(x = Q11, fill = type)) +
  geom_bar(position = "stack") + coord_flip() +
  scale_x_discrete(limit = c("UberEats", "SkiptheDishes", "DoorDash", "In-house delivery service", "Other", "None")) +
  labs(x = "Delivery Service",
       y = "# of Restaurants",
       title = "Food courier service popularity (most orders)",
       fill = "Condition") +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE)) + 
  theme_fivethirtyeight()
```

### Effects of Intervention on Number of Employees

```{r Q5 + Q6 Table, echo = FALSE, message = FALSE}
### Prior to (intervention start date), how many people did you employ?
### How many people do you currently employ?

t1 <-
all_simulated_dataset %>%
  group_by(type) %>%
  summarise(prior_employees = mean(Q5, na.rm = TRUE, .groups = NULL))

t2 <-
all_simulated_dataset %>%
  group_by(type) %>%
  summarise(curr_employees = mean(Q6, na.rm = TRUE), .groups = NULL)

total <- merge(t1, t2, by = c("type"))


kable(total,
      col.names = c("Intervention Group",
                  "# of Employees Prior to Intervention",
                  "Current # of Employees")) %>%
      footnote(general = "Change in # of employees before and after intervention period (Q5 + Q6)") %>%
  kable_paper(c("striped", "hover"))

### T-Tests (Welch's)

#Q5
control_q5 <-
  all_simulated_dataset %>%
  filter(type == "Control") %>%
  select(Q5)
treatment_q5 <-
  all_simulated_dataset %>%
  filter(type == "Treated") %>%
  select(Q5)
t3 <- t.test(control_q5, treatment_q5, paired = FALSE)

#Q6
control_q6 <-
  all_simulated_dataset %>%
  filter(type == "Control") %>%
  select(Q6)
treatment_q6 <-
  all_simulated_dataset %>%
  filter(type == "Treated") %>%
  select(Q6)
t4 <- t.test(control_q6, treatment_q6, paired = FALSE)

#Q5 + Q6 compiled t-test table
t_tests <- map_df(list(t3, t4), tidy)
t_tests = subset(t_tests, select = -c(alternative, method, conf.low, conf.high))
t_tests %>%  
  kable(
    col.names = c("Mean of the Differences",
                  "Mean (Employees Before Intervention)",
                  "Mean (Employees Post-Intervention)",
                  "t",
                  "p",
                  "df")
    
  ) %>%
  add_header_above(c(" ", "Control" = 1, "Treated" = 1, " ", " ", " ")) %>%
  kable_paper(c("striped", "hover")) %>%
  landscape()

```

### Effects of Intervention on Revenue

```{r Q7, echo = FALSE, message = FALSE}
### Between Oct 1 and Dec 31 was your total sales revenue higher, lower, or about the same as it was during the previous quarter (last quarter dates)? *
### Higher
### Lower
### Around the Same

ggplot(data = all_simulated_dataset, mapping = aes(x = Q7, fill = type)) + 
  geom_bar() +
  labs(x = "Revenue Change",
       y = "# of Restaurants",
       title = "Revenue changes between Oct 1 and Dec 31",
       fill = "Condition") +
  theme_fivethirtyeight() + 
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE))

q7_chi <- table(all_simulated_dataset$Q7, all_simulated_dataset$type)
chisq.test(q7_chi)
```

```{r Q8, echo = FALSE, message = FALSE}
### What was the approximate percentage decrease in total sales revenue between Oct 1 and Dec 31 compared to the during the previous quarter (last quarter dates)? *
### Decline of 50% or more
### Decline of 25% to 50%
### Decline of 10% to 25%
### Decline of 10% or less

ggplot(data = all_simulated_dataset, mapping = aes (x = Q8, fill = type)) +
  geom_bar(position = "stack") + coord_flip() +
  scale_x_discrete(limit = c("Decline of 50% or more", "Decline of 25% to 50%", "Decline of 10% to 25%", "Decline of 10% or less")) + 
  labs(x = "Aprrox. % Decrease in Total Sales Revenue",
       y = "# of Restaurants",
       title = str_wrap("Percentage of total sales revenue decrease between Oct 1 and Dec 31", 40),
       fill = "Condition") +
  theme_fivethirtyeight() + 
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE))

q8_chi <- table(all_simulated_dataset$Q8, all_simulated_dataset$type)
chisq.test(q8_chi)
```

```{r Q9, echo = FALSE, message = FALSE}
### Before Oct 1st, approximately how much of your total monthly sales revenue came from takeout or delivery? *
### Did not offer takeout or delivery
### 25% or less
### 25- 50%
### 50-75%
### 75% or more
 
my_title = "Total revenue from takeout/delivery prior to Oct 1"
ggplot(data = all_simulated_dataset, mapping = aes (x = Q9, fill = type)) +
  geom_bar(position = "stack") +  coord_flip() + 
  scale_x_discrete(limit = c("Did not offer takeout or delivery", "25% or less", "25-50%", "50-75%", "75% or more")) + 
  labs(x = "Total Monthly Sales Revenue Fromt Takeout or Delivery",
       y = "# of Restaurants",
       title = str_wrap("Total revenue from takeout or delivery prior to Oct 1", 30),
       fill = "Condition") +
  theme_fivethirtyeight() + 
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE))
```

## Effects of Intervention on Menu Prices 

```{r Q10, echo = FALSE, message = FALSE}
### Between (start date of intervention) and (end date of intervention), did you make any adjustments to your menu prices?
### Yes, prices were raised
### Yes, prices were lowered
### No changes were made

ggplot(data = all_simulated_dataset, mapping = aes (x = Q10, fill = type)) +
  geom_bar() +  
  coord_flip() + 
  scale_x_discrete(limit = c("Yes, prices were raised", "Yes, prices were lowered", "No changes were made")) + 
  labs(x = "Adjustments to Menu Prices",
       y = "# of Restaurants",
       title = str_wrap("Menu adjustments between Oct 1 and Dec 31", 30),
       fill = "Condition") +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE)) +
  theme_fivethirtyeight()

q10_chi <- table(all_simulated_dataset$Q10, all_simulated_dataset$type)
chisq.test(q10_chi)
```

## Effects of Intervention on Hours/Days of Operation

```{r Q12, echo = FALSE, message = FALSE}
### Between (start date of intervention) and (end date of intervention) did you reduce your ### restaurantâ€™s hours of operation?
### Yes
### No

ggplot(data = all_simulated_dataset, mapping = aes(x = Q12, fill = type)) +
  geom_bar(position = position_dodge(1)) +
  labs(x = "Reduction in hours of operation",
       y = "# of restaurants",
       title = str_wrap("Reducton in operating hours between Oct 1 and Dec 31", 30),
       fill = "Condition") +
  theme_fivethirtyeight() +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE))

q12_chi <- table(all_simulated_dataset$Q12, all_simulated_dataset$type)
chisq.test(q12_chi)
```

```{r Q13, echo = FALSE, message = FALSE}
### If yes, approximately how many hours per week did you reduce by
### 15% or less
### 15-30%
### 30-50%
### 50-75%
### 75% or more

ggplot(data = all_simulated_dataset, mapping = aes(x = Q13, fill = type)) +
  geom_bar(position = "stack") +
  labs(x = "Hours Reduced per Week",
       y = "# of Restaurants",
       title = str_wrap("Percentage of hours reduced between Oct 1 and Dec 31", 30),
       fill = "Condition") +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE)) +
  theme_fivethirtyeight()
```

```{r Q14, echo = FALSE, message = FALSE}
### Between (start date of intervention) and (end date of intervention) did you reduce the 
### number of days your restaurant was open to the public?
### Yes
### No 

ggplot(data = all_simulated_dataset, mapping = aes(x = Q14, fill = type)) +
  geom_bar(position = position_dodge(1)) +
  labs(x = "Reduction in Days of Operation",
       y = "# of Restaurants",
       title = str_wrap("Reduction of operating days between Oct 1 and Dec 31", 30),
       fill = "Condition") +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE)) +
  theme_fivethirtyeight()

### Chi-squared test
q14_chi <- table(all_simulated_dataset$Q14, all_simulated_dataset$type) %>%
  chisq.test()

tableChisq(q14_chi$method, q14_chi$statistic, q14_chi$parameter, q14_chi$p.value)

```

```{r Q15, echo = FALSE, message = FALSE}
### If yes, how many days per week did you reduce by?
### 1-2 days
### 3-4 days
### 5-6 days
### 7 days
### Not Applicable

### bar graph/pie chart/line

ggplot(data = all_simulated_dataset, mapping = aes(x = Q15, fill = type)) +
  geom_bar(position = "stack") +
  labs(x = "Days Reduced",
       y = "# of Restaurants",
       title = "Reduction in days of operation per week",
       fill = "Condition") +
    scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE)) +
  theme_fivethirtyeight()
```

```{r Q16, echo = FALSE, message = FALSE}
### Have you applied for and received any external funding or grants for your restaurant since (intervention start date)?
### Yes
### No

ggplot(data = all_simulated_dataset, mapping = aes(x = Q16, fill = type)) +
  geom_bar(position = position_dodge(1)) +
  labs(x = "Application status",
       y = "# of restaurants",
       title = str_wrap("Funding Applications between Oct 1 and Dec 31", 30),
       fill = "Condition") +
  theme_fivethirtyeight() +
  scale_fill_tableau(labels = c("Control", "Intervention"), guide = guide_legend(reverse = TRUE))
```



\newpage


# Appendix {-}

\newpage


# References